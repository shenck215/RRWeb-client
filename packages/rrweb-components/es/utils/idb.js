function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg);var value=info.value}catch(error){reject(error);return}if(info.done){resolve(value)}else{Promise.resolve(value).then(_next,_throw)}}function _async_to_generator(fn){return function(){var self=this,args=arguments;return new Promise(function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(undefined)})}}function _ts_generator(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(t[0]&1)throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),"throw":verb(1),"return":verb(2)},typeof Symbol==="function"&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return step([n,v])}}function step(op){if(f)throw new TypeError("Generator is already executing.");while(_)try{if(f=1,y&&(t=op[0]&2?y["return"]:op[0]?y["throw"]||((t=y["return"])&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;if(y=0,t)op=[op[0]&2,t.value];switch(op[0]){case 0:case 1:t=op;break;case 4:_.label++;return{value:op[1],done:false};case 5:_.label++;y=op[1];op=[0];continue;case 7:op=_.ops.pop();_.trys.pop();continue;default:if(!(t=_.trys,t=t.length>0&&t[t.length-1])&&(op[0]===6||op[0]===2)){_=0;continue}if(op[0]===3&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(op[0]===6&&_.label<t[1]){_.label=t[1];t=op;break}if(t&&_.label<t[2]){_.label=t[2];_.ops.push(op);break}if(t[2])_.ops.pop();_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e];y=0}finally{f=t=0}if(op[0]&5)throw op[1];return{value:op[0]?op[1]:void 0,done:true}}}import"core-js/modules/es.promise.js";import"core-js/modules/es.object.to-string.js";import"core-js/modules/es.array.filter.js";import"core-js/modules/es.array.sort.js";import"core-js/modules/es.array.slice.js";import"core-js/modules/es.array.map.js";import"core-js/modules/es.string.iterator.js";import"core-js/modules/es.array.iterator.js";import"core-js/modules/web.dom-collections.iterator.js";var DB_NAME="rrweb-recorder";var DB_VERSION=1;var STORE="batches";var DAY_MS=24*60*60*1e3;function openDB(){return new Promise(function(resolve,reject){var req=indexedDB.open(DB_NAME,DB_VERSION);req.onerror=function(){return reject(req.error)};req.onupgradeneeded=function(){var db=req.result;if(!db.objectStoreNames.contains(STORE)){var store=db.createObjectStore(STORE,{keyPath:"id",autoIncrement:true});store.createIndex("by_session","sessionId",{unique:false});store.createIndex("by_session_seq",["sessionId","seq"],{unique:true});store.createIndex("by_created","createdAt",{unique:false})}};req.onsuccess=function(){return resolve(req.result)}})}export function idbPutBatch(row){return _idbPutBatch.apply(this,arguments)}function _idbPutBatch(){_idbPutBatch=_async_to_generator(function(row){var db;return _ts_generator(this,function(_state){switch(_state.label){case 0:return[4,openDB()];case 1:db=_state.sent();return[2,new Promise(function(resolve,reject){var tx=db.transaction(STORE,"readwrite");var req=tx.objectStore(STORE).add(row);req.onsuccess=function(){return resolve(req.result)};req.onerror=function(){return reject(req.error)}})]}})});return _idbPutBatch.apply(this,arguments)}export function idbDeleteBatch(id){return _idbDeleteBatch.apply(this,arguments)}function _idbDeleteBatch(){_idbDeleteBatch=_async_to_generator(function(id){var db;return _ts_generator(this,function(_state){switch(_state.label){case 0:return[4,openDB()];case 1:db=_state.sent();return[2,new Promise(function(resolve,reject){var tx=db.transaction(STORE,"readwrite");var req=tx.objectStore(STORE).delete(id);req.onsuccess=function(){return resolve()};req.onerror=function(){return reject(req.error)}})]}})});return _idbDeleteBatch.apply(this,arguments)}export function idbCountBatches(sessionId){return _idbCountBatches.apply(this,arguments)}function _idbCountBatches(){_idbCountBatches=_async_to_generator(function(sessionId){var db;return _ts_generator(this,function(_state){switch(_state.label){case 0:return[4,openDB()];case 1:db=_state.sent();return[2,new Promise(function(resolve,reject){var tx=db.transaction(STORE,"readonly");var store=tx.objectStore(STORE);if(!sessionId){var req=store.count();req.onsuccess=function(){return resolve(req.result)};req.onerror=function(){return reject(req.error)}}else{var idx=store.index("by_session");var req1=idx.count(IDBKeyRange.only(sessionId));req1.onsuccess=function(){return resolve(req1.result)};req1.onerror=function(){return reject(req1.error)}}})]}})});return _idbCountBatches.apply(this,arguments)}export function idbGetOldestBySession(sessionId,limit){return _idbGetOldestBySession.apply(this,arguments)}function _idbGetOldestBySession(){_idbGetOldestBySession=_async_to_generator(function(sessionId,limit){var db;return _ts_generator(this,function(_state){switch(_state.label){case 0:return[4,openDB()];case 1:db=_state.sent();return[2,new Promise(function(resolve,reject){var tx=db.transaction(STORE,"readonly");var store=tx.objectStore(STORE);var req=store.getAll();req.onsuccess=function(){var rows=req.result.filter(function(r){return r.sessionId===sessionId}).sort(function(a,b){return a.createdAt-b.createdAt}).slice(0,limit).map(function(r){return r.id});resolve(rows)};req.onerror=function(){return reject(req.error)}})]}})});return _idbGetOldestBySession.apply(this,arguments)}export function idbPruneByCap(sessionId,cap){return _idbPruneByCap.apply(this,arguments)}function _idbPruneByCap(){_idbPruneByCap=_async_to_generator(function(sessionId,cap){var count,needDelete,ids;return _ts_generator(this,function(_state){switch(_state.label){case 0:return[4,idbCountBatches(sessionId)];case 1:count=_state.sent();if(count<=cap)return[2,{pruned:0}];needDelete=count-cap;return[4,idbGetOldestBySession(sessionId,needDelete)];case 2:ids=_state.sent();return[4,Promise.all(ids.map(idbDeleteBatch))];case 3:_state.sent();return[2,{pruned:ids.length}]}})});return _idbPruneByCap.apply(this,arguments)}export function idbPruneByAge(days){return _idbPruneByAge.apply(this,arguments)}function _idbPruneByAge(){_idbPruneByAge=_async_to_generator(function(days){var db,cutoff;return _ts_generator(this,function(_state){switch(_state.label){case 0:return[4,openDB()];case 1:db=_state.sent();cutoff=Date.now()-days*DAY_MS;return[2,new Promise(function(resolve,reject){var tx=db.transaction(STORE,"readwrite");var store=tx.objectStore(STORE);var idx=store.index("by_created");var req=idx.openCursor();var pruned=0;req.onsuccess=_async_to_generator(function(){var cursor,row;return _ts_generator(this,function(_state){switch(_state.label){case 0:cursor=req.result;if(!cursor){resolve({pruned:pruned});return[2]}row=cursor.value;if(!(row.createdAt<cutoff))return[3,2];return[4,new Promise(function(res,rej){var del=cursor.delete();del.onsuccess=function(){pruned+=1;res()};del.onerror=function(){return rej(del.error)}})];case 1:_state.sent();_state.label=2;case 2:cursor.continue();return[2]}})});req.onerror=function(){return reject(req.error)}})]}})});return _idbPruneByAge.apply(this,arguments)}export function idbMarkSent(id){return _idbMarkSent.apply(this,arguments)}function _idbMarkSent(){_idbMarkSent=_async_to_generator(function(id){var db;return _ts_generator(this,function(_state){switch(_state.label){case 0:return[4,openDB()];case 1:db=_state.sent();return[2,new Promise(function(resolve,reject){var tx=db.transaction(STORE,"readwrite");var store=tx.objectStore(STORE);var getReq=store.get(id);getReq.onsuccess=function(){var row=getReq.result;if(!row){resolve();return}row.sentAt=Date.now();var putReq=store.put(row);putReq.onsuccess=function(){return resolve()};putReq.onerror=function(){return reject(putReq.error)}};getReq.onerror=function(){return reject(getReq.error)}})]}})});return _idbMarkSent.apply(this,arguments)}export function idbDeleteSentBefore(ts){return _idbDeleteSentBefore.apply(this,arguments)}function _idbDeleteSentBefore(){_idbDeleteSentBefore=_async_to_generator(function(ts){var db;return _ts_generator(this,function(_state){switch(_state.label){case 0:return[4,openDB()];case 1:db=_state.sent();return[2,new Promise(function(resolve,reject){var tx=db.transaction(STORE,"readwrite");var store=tx.objectStore(STORE);var req=store.getAll();req.onsuccess=function(){var rows=req.result;var toDel=rows.filter(function(r){return r.sentAt&&r.sentAt<ts}).map(function(r){return r.id});Promise.all(toDel.map(function(id){return idbDeleteBatch(id)})).then(function(){return resolve(toDel.length)}).catch(reject)};req.onerror=function(){return reject(req.error)}})]}})});return _idbDeleteSentBefore.apply(this,arguments)}export function idbGetUnsentBatches(sessionId){return _idbGetUnsentBatches.apply(this,arguments)}function _idbGetUnsentBatches(){_idbGetUnsentBatches=_async_to_generator(function(sessionId){var db;return _ts_generator(this,function(_state){switch(_state.label){case 0:return[4,openDB()];case 1:db=_state.sent();return[2,new Promise(function(resolve,reject){var tx=db.transaction(STORE,"readonly");var idx=tx.objectStore(STORE).index("by_session");var req=idx.getAll(IDBKeyRange.only(sessionId));req.onsuccess=function(){var rows=req.result.filter(function(r){return!r.sentAt}).sort(function(a,b){return a.seq-b.seq});resolve(rows)};req.onerror=function(){return reject(req.error)}})]}})});return _idbGetUnsentBatches.apply(this,arguments)}
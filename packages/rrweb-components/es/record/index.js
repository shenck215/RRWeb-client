function _array_like_to_array(arr,len){if(len==null||len>arr.length)len=arr.length;for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}function _array_with_holes(arr){if(Array.isArray(arr))return arr}function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg);var value=info.value}catch(error){reject(error);return}if(info.done){resolve(value)}else{Promise.resolve(value).then(_next,_throw)}}function _async_to_generator(fn){return function(){var self=this,args=arguments;return new Promise(function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(undefined)})}}function _define_property(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}function _iterable_to_array_limit(arr,i){var _i=arr==null?null:typeof Symbol!=="undefined"&&arr[Symbol.iterator]||arr["@@iterator"];if(_i==null)return;var _arr=[];var _n=true;var _d=false;var _s,_e;try{for(_i=_i.call(arr);!(_n=(_s=_i.next()).done);_n=true){_arr.push(_s.value);if(i&&_arr.length===i)break}}catch(err){_d=true;_e=err}finally{try{if(!_n&&_i["return"]!=null)_i["return"]()}finally{if(_d)throw _e}}return _arr}function _non_iterable_rest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _object_spread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};var ownKeys=Object.keys(source);if(typeof Object.getOwnPropertySymbols==="function"){ownKeys=ownKeys.concat(Object.getOwnPropertySymbols(source).filter(function(sym){return Object.getOwnPropertyDescriptor(source,sym).enumerable}))}ownKeys.forEach(function(key){_define_property(target,key,source[key])})}return target}function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly){symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable})}keys.push.apply(keys,symbols)}return keys}function _object_spread_props(target,source){source=source!=null?source:{};if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source))}else{ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key))})}return target}function _sliced_to_array(arr,i){return _array_with_holes(arr)||_iterable_to_array_limit(arr,i)||_unsupported_iterable_to_array(arr,i)||_non_iterable_rest()}function _unsupported_iterable_to_array(o,minLen){if(!o)return;if(typeof o==="string")return _array_like_to_array(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);if(n==="Object"&&o.constructor)n=o.constructor.name;if(n==="Map"||n==="Set")return Array.from(n);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _array_like_to_array(o,minLen)}function _ts_generator(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(t[0]&1)throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),"throw":verb(1),"return":verb(2)},typeof Symbol==="function"&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return step([n,v])}}function step(op){if(f)throw new TypeError("Generator is already executing.");while(_)try{if(f=1,y&&(t=op[0]&2?y["return"]:op[0]?y["throw"]||((t=y["return"])&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;if(y=0,t)op=[op[0]&2,t.value];switch(op[0]){case 0:case 1:t=op;break;case 4:_.label++;return{value:op[1],done:false};case 5:_.label++;y=op[1];op=[0];continue;case 7:op=_.ops.pop();_.trys.pop();continue;default:if(!(t=_.trys,t=t.length>0&&t[t.length-1])&&(op[0]===6||op[0]===2)){_=0;continue}if(op[0]===3&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(op[0]===6&&_.label<t[1]){_.label=t[1];t=op;break}if(t&&_.label<t[2]){_.label=t[2];_.ops.push(op);break}if(t[2])_.ops.pop();_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e];y=0}finally{f=t=0}if(op[0]&5)throw op[1];return{value:op[0]?op[1]:void 0,done:true}}}import"core-js/modules/es.json.stringify.js";import"core-js/modules/es.promise.js";import"core-js/modules/es.object.to-string.js";import"core-js/modules/es.array.push.js";import"core-js/modules/es.error.cause.js";import"core-js/modules/es.array.concat.js";import"core-js/modules/es.array.slice.js";import{jsx as _jsx,jsxs as _jsxs}from"react/jsx-runtime";import React,{useEffect,useRef,useState}from"react";import{record}from"rrweb";import{gzipJson}from"../utils/gzipJson";import{idbDeleteBatch,idbDeleteSentBefore,idbGetUnsentBatches,idbMarkSent,idbPruneByAge,idbPruneByCap,idbPutBatch}from"../utils/idb";import{Main}from"./index.styled";console.log("%c隐私提示：已默认 maskAllInputs（表单打码），你也可以对特定 DOM 使用 .rr-block / .rr-mask 类控制录制粒度。","color: #e66a34; ");var apiBase="http://localhost:4000";var BATCH_INTERVAL=3e3;var BATCH_SIZE=50;var MAX_BATCH_BYTES=200*1024;var USE_GZIP=true;var OBSERVE_MODE=false;var DELAY_DELETE_MS=6e4;var HEARTBEAT_INTERVAL=1e4;var MAX_PENDING_BATCHES=500;var MAX_AGE_DAYS=7;var KEEPALIVE_MAX_BYTES=60*1024;var roughSizeOf=function(obj){return new Blob([JSON.stringify(obj)]).size};var RecordComponent=function(){var _useState=_sliced_to_array(useState(""),2),sessionId=_useState[0],setSessionId=_useState[1];var _useState1=_sliced_to_array(useState(false),2),isRecording=_useState1[0],setIsRecording=_useState1[1];var stopFn=useRef(null);var buffer=useRef([]);var flushTimer=useRef(null);var heartbeatTimer=useRef(null);var inFlight=useRef(false);var uploadingRef=useRef(false);var resumingRef=useRef(false);var seqRef=useRef(1);var cleanTickRef=useRef(0);var sendPayload=function(){var _ref=_async_to_generator(function(url,body){var keepalive,res;var _arguments=arguments;return _ts_generator(this,function(_state){switch(_state.label){case 0:keepalive=_arguments.length>2&&_arguments[2]!==void 0?_arguments[2]:false;_state.label=1;case 1:if(!inFlight.current)return[3,3];return[4,new Promise(function(r){return setTimeout(r,8)})];case 2:_state.sent();return[3,1];case 3:inFlight.current=true;_state.label=4;case 4:_state.trys.push([4,,6,7]);return[4,fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},keepalive:keepalive,body:JSON.stringify(body)})];case 5:res=_state.sent();if(!res.ok)throw new Error("HTTP ".concat(res.status));return[3,7];case 6:inFlight.current=false;return[7];case 7:return[2]}})});return function sendPayload(url,body){return _ref.apply(this,arguments)}}();var postBatch=function(){var _ref=_async_to_generator(function(curSessionId,events,opts){var _opts,payloadBase,json,_opts1,b64,e;return _ts_generator(this,function(_state){switch(_state.label){case 0:payloadBase={sessionId:curSessionId};console.log(events);json=JSON.stringify(events);if(!(USE_GZIP&&"CompressionStream"in window))return[3,5];_state.label=1;case 1:_state.trys.push([1,4,,5]);return[4,gzipJson(json)];case 2:b64=_state.sent();return[4,sendPayload("".concat(apiBase,"/events"),_object_spread_props(_object_spread({},payloadBase),{compressed:true,payload:b64}),(_opts1=opts)===null||_opts1===void 0?void 0:_opts1.keepalive)];case 3:_state.sent();return[2];case 4:e=_state.sent();console.warn("gzip failed, fallback to plain:",e);return[3,5];case 5:return[4,sendPayload("".concat(apiBase,"/events"),_object_spread_props(_object_spread({},payloadBase),{events:events}),(_opts=opts)===null||_opts===void 0?void 0:_opts.keepalive)];case 6:_state.sent();return[2]}})});return function postBatch(curSessionId,events,opts){return _ref.apply(this,arguments)}}();var processPendingQueue=function(){var _ref=_async_to_generator(function(curSessionId,opts){var rows,i,row,e;return _ts_generator(this,function(_state){switch(_state.label){case 0:if(!curSessionId)return[2];if(uploadingRef.current)return[2];uploadingRef.current=true;_state.label=1;case 1:_state.trys.push([1,,16,17]);_state.label=2;case 2:if(!true)return[3,15];return[4,idbGetUnsentBatches(curSessionId)];case 3:rows=_state.sent();if(!rows.length)return[3,15];i=0;_state.label=4;case 4:if(!(i<rows.length))return[3,14];row=rows[i];_state.label=5;case 5:_state.trys.push([5,11,,13]);return[4,postBatch(curSessionId,row.events,opts)];case 6:_state.sent();if(!OBSERVE_MODE)return[3,8];return[4,idbMarkSent(row.id)];case 7:_state.sent();return[3,10];case 8:return[4,idbDeleteBatch(row.id)];case 9:_state.sent();_state.label=10;case 10:return[3,13];case 11:e=_state.sent();console.warn("send one batch failed, will retry later:",e);return[4,new Promise(function(r){return setTimeout(r,1e3)})];case 12:_state.sent();return[2];case 13:i+=1;return[3,4];case 14:return[3,2];case 15:return[3,17];case 16:uploadingRef.current=false;return[7];case 17:return[2]}})});return function processPendingQueue(curSessionId,opts){return _ref.apply(this,arguments)}}();var flush=function(){var _ref=_async_to_generator(function(curSessionId,opts){var _opts,batch,estimatedBytes,e,e1;return _ts_generator(this,function(_state){switch(_state.label){case 0:if(!curSessionId||buffer.current.length===0)return[2];batch=buffer.current.slice();buffer.current=[];estimatedBytes=roughSizeOf(batch);return[4,idbPutBatch({sessionId:curSessionId,seq:seqRef.current++,createdAt:Date.now(),events:batch})];case 1:_state.sent();idbPruneByCap(curSessionId,MAX_PENDING_BATCHES).catch(function(err){return console.warn("idbPruneByCap error",err)});if(!((_opts=opts)===null||_opts===void 0?void 0:_opts.keepalive))return[3,6];if(estimatedBytes>KEEPALIVE_MAX_BYTES)return[2];_state.label=2;case 2:_state.trys.push([2,4,,5]);return[4,processPendingQueue(curSessionId,{keepalive:true})];case 3:_state.sent();return[3,5];case 4:e=_state.sent();console.warn("flush(keepalive)->processPendingQueue error:",e);return[3,5];case 5:return[2];case 6:_state.trys.push([6,8,,9]);return[4,processPendingQueue(curSessionId)];case 7:_state.sent();return[3,9];case 8:e1=_state.sent();console.warn("flush->processPendingQueue error:",e1);return[3,9];case 9:return[2]}})});return function flush(curSessionId,opts){return _ref.apply(this,arguments)}}();var scheduleFlush=function(curSessionId){if(flushTimer.current)return;flushTimer.current=window.setInterval(function(){void flush(curSessionId)},BATCH_INTERVAL)};var stopScheduleFlush=function(){if(flushTimer.current){window.clearInterval(flushTimer.current);flushTimer.current=null}};var startHeartbeat=function(curSessionId){if(heartbeatTimer.current)return;heartbeatTimer.current=window.setInterval(_async_to_generator(function(){var cutoff,e;return _ts_generator(this,function(_state){switch(_state.label){case 0:_state.trys.push([0,4,,5]);if(!buffer.current.length)return[3,2];return[4,flush(curSessionId)];case 1:_state.sent();_state.label=2;case 2:return[4,processPendingQueue(curSessionId)];case 3:_state.sent();cleanTickRef.current=(cleanTickRef.current+1)%6;if(cleanTickRef.current===0){idbPruneByAge(MAX_AGE_DAYS).then(function(param){var pruned=param.pruned;if(pruned)console.log("[IDB] aged prune:",pruned)}).catch(function(err){return console.warn("idbPruneByAge error",err)})}if(OBSERVE_MODE){cutoff=Date.now()-DELAY_DELETE_MS;idbDeleteSentBefore(cutoff).then(function(n){if(n)console.log("[IDB] delayed delete:",n)}).catch(function(err){return console.warn("delayed delete error",err)})}return[3,5];case 4:e=_state.sent();console.warn("heartbeat tick error:",e);return[3,5];case 5:return[2]}})}),HEARTBEAT_INTERVAL)};var stopHeartbeat=function(){if(heartbeatTimer.current){window.clearInterval(heartbeatTimer.current);heartbeatTimer.current=null}};var resumePending=function(){var _ref=_async_to_generator(function(curSessionId){return _ts_generator(this,function(_state){switch(_state.label){case 0:if(!curSessionId||resumingRef.current)return[2];resumingRef.current=true;_state.label=1;case 1:_state.trys.push([1,,3,4]);return[4,processPendingQueue(curSessionId)];case 2:_state.sent();return[3,4];case 3:resumingRef.current=false;return[7];case 4:return[2]}})});return function resumePending(curSessionId){return _ref.apply(this,arguments)}}();var createSession=function(){var _ref=_async_to_generator(function(){var r,data;return _ts_generator(this,function(_state){switch(_state.label){case 0:return[4,fetch("".concat(apiBase,"/session"),{method:"POST"})];case 1:r=_state.sent();return[4,r.json()];case 2:data=_state.sent();return[2,data.sessionId]}})});return function createSession(){return _ref.apply(this,arguments)}}();var handleStartRecord=function(){var _ref=_async_to_generator(function(){var curSessionId,stop;return _ts_generator(this,function(_state){switch(_state.label){case 0:curSessionId=sessionId;if(!!curSessionId)return[3,2];return[4,createSession()];case 1:curSessionId=_state.sent();setSessionId(curSessionId);_state.label=2;case 2:return[4,resumePending(curSessionId)];case 3:_state.sent();stop=record({emit:function(event){buffer.current.push(event);var tooMany=buffer.current.length>=BATCH_SIZE;var tooBig=roughSizeOf(buffer.current)>=MAX_BATCH_BYTES;if(tooMany||tooBig){void flush(curSessionId)}},maskAllInputs:true,blockClass:"rr-block",ignoreClass:"rr-ignore",maskTextClass:"rr-mask",inlineStylesheet:true,recordCanvas:true,slimDOMOptions:{script:true,comment:true,headFavicon:true,headWhitespace:true}});if(stop){stopFn.current=stop}scheduleFlush(curSessionId);startHeartbeat(curSessionId);setIsRecording(true);console.log("recording started",{curSessionId:curSessionId});return[2]}})});return function handleStartRecord(){return _ref.apply(this,arguments)}}();var handleStopRecord=function(){var _ref=_async_to_generator(function(){return _ts_generator(this,function(_state){switch(_state.label){case 0:if(stopFn.current){stopFn.current();stopFn.current=null}stopScheduleFlush();stopHeartbeat();return[4,flush(sessionId)];case 1:_state.sent();return[4,processPendingQueue(sessionId)];case 2:_state.sent();setIsRecording(false);console.log("recording stopped");return[2]}})});return function handleStopRecord(){return _ref.apply(this,arguments)}}();useEffect(function(){var onHidden=function(){if(!sessionId)return;void flush(sessionId,{keepalive:true})};var onVisibilityChange=function(){if(document.visibilityState==="hidden")onHidden()};document.addEventListener("visibilitychange",onVisibilityChange);window.addEventListener("pagehide",onHidden);return function(){document.removeEventListener("visibilitychange",onVisibilityChange);window.removeEventListener("pagehide",onHidden)}},[sessionId]);return _jsxs(Main,{children:[_jsx("h2",{children:"RRWeb 录制 Demo"}),_jsxs("div",{className:"row",children:[_jsx("button",{id:"btnStart",type:"button",disabled:isRecording,onClick:handleStartRecord,children:"开始录制"}),_jsx("button",{id:"btnStop",type:"button",disabled:!isRecording,onClick:handleStopRecord,children:"停止录制"})]}),_jsxs("div",{className:"row tip",children:["隐私提示：已默认 maskAllInputs（表单打码），你也可以对特定 DOM 使用",_jsx("code",{children:".rr-block"})," / ",_jsx("code",{children:".rr-mask"})," 类控制录制粒度。"]})]})};export default RecordComponent;